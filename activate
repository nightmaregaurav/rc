# Determine if benchmarking is enabled
if [ -n "${RC_BENCHMARK}" ]; then
    current_time_ms() {
        if command -v date >/dev/null 2>&1; then
            # Use date command if available
            if date --version >/dev/null 2>&1; then
                # GNU date (Linux) - use milliseconds
                echo $(date +%s%3N)
            else
                # macOS date or other Unix-like systems without %3N
                echo $(($(date +%s) * 1000 + $(date +%N | cut -b1-3)))
            fi
        else
            echo "Error: 'date' command is not available"
            return 1
        fi
    }
    __bench_start_time=0
    benchmark() {
        local step_name="$1"
        if [ "$step_name" = "Start" ]; then
            __bench_start_time=$(current_time_ms)
            echo "[BENCHMARK] ${step_name}: Benchmarking started"
            return
        fi
        local now=$(current_time_ms)
        local elapsed=$((now - __bench_start_time))
        echo "[BENCHMARK] ${step_name}: ${elapsed} ms"
        __bench_start_time=$now
    }
else
    benchmark() { :; }  # no-op if benchmarking is disabled
fi
benchmark "Start"

# Determine the directory of this sourced file
if [ -n "${BASH_SOURCE[0]}" ]; then
    export current_rc_script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
elif [ -n "${ZSH_VERSION}" ]; then
    export current_rc_script_dir="$(cd "$(dirname "${(%):-%x}")" && pwd)"
elif [ -n "${.sh.file}" ]; then
    export current_rc_script_dir="$(cd "$(dirname "${.sh.file}")" && pwd)"
else
    export current_rc_script_dir="$(pwd)"
fi
benchmark "Determine current_rc_script_dir"

# Enable loading completion in zsh
if [ -n "${ZSH_VERSION}" ]; then
    autoload -Uz compinit && compinit
    autoload -Uz bashcompinit && bashcompinit
fi
benchmark "Enabling zsh completion"

# Source environment variables, tools, aliases
source "$current_rc_script_dir/envs"

source "$current_rc_script_dir/tools/source"

source "$current_rc_script_dir/aliases"
benchmark "Sourced aliases"

# Save public IP Address to a file
(publicip > "$HOME/.ip.public" &) > /dev/null 2>&1
benchmark "Save public IP"

# Save local IP Address to a file
(localip > "$HOME/.ip.local" &) > /dev/null 2>&1
benchmark "Save local IP"

# Set history append mode
if [[ -n "${ZSH_VERSION}" ]]; then
  setopt INC_APPEND_HISTORY
else
  shopt -s histappend
  PROMPT_COMMAND="history -a;$PROMPT_COMMAND"
fi
benchmark "Configure history append"

# Filter duplicates from PATH
export PATH=$(echo "$PATH" | awk -v RS=':' '!seen[$0]++ { path = path (NR==1 ? "" : ":") $0 } END { print path }')
benchmark "Filter duplicates from PATH"

benchmark "End"

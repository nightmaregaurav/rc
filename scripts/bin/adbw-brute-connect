#!/usr/bin/env bash

# Help
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
  echo "Usage: adbw-brute-connect <IP Address or Hostname>"
  echo
  echo "Connects to paired android device with wireless adb regardless of the current adb port."
  echo "This script uses nmap to find open ports in the range 37000-44000 and tries to connect to each one."
  echo
  echo "Examples:"
  echo "  adbw-brute-connect 192.168.1.1"
  exit 0
fi

if [ -z "$1" ]; then
  echo "Missing argument: <IP Address or Hostname>"
  echo "Try 'adbw-brute-connect --help' for more information."
  exit 1
fi

ip="$1"

if ! command -v nmap >/dev/null 2>&1; then
  echo "Error: nmap not found. Please install nmap."
  exit 1
fi

if ! command -v adb >/dev/null 2>&1; then
  echo "Error: adb not found. Please install Android Platform Tools."
  exit 1
fi

ports=$(nmap -p 37000-44000 "$ip" -oG - | awk '/Ports:/{print $5}' | tr ',' '\n' | awk -F/ '$2=="open" {print $1}')

if [[ -z "$ports" ]]; then
  echo "No open ports found in range 37000-44000 on $ip."
  exit 1
fi

for port in $ports; do
  echo "Trying to connect to $ip:$port"
  adb connect "$ip:$port"
done

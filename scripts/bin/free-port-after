#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.14"
# dependencies = [
#     "argcomplete",
# ]
# ///

import socket
import sys
import os
import argparse
import argcomplete


def is_port_free(port: int) -> bool:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        try:
            s.bind(("127.0.0.1", port))
            return True
        except OSError:
            return False


def find_free_port_after(start_port: int) -> int:
    for port in range(start_port, 65536):
        if is_port_free(port):
            return port
    return -1


def complete_flags(prefix, parsed_args, **_):
    return [opt for opt in ("-h", "--help") if opt.startswith(prefix)]


def main():
    script_name = os.path.basename(sys.argv[0])

    parser = argparse.ArgumentParser(
        prog=script_name,
        description="Finds a free TCP port after the specified port (inclusive).",
        epilog=f"Examples:\n  {script_name} 5000",
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False,
    )

    parser.add_argument(
        "-h", "--help",
        action="help",
        help="Show help message and exit.",
    )

    parser.add_argument(
        "port",
        type=int,
        help="Starting port number to check from.",
    ).completer = None

    argcomplete.autocomplete(parser, always_complete_options=False)
    args = parser.parse_args()

    if not (0 <= args.port <= 65535):
        print("Error: Port must be between 0 and 65535.")
        sys.exit(1)

    free_port = find_free_port_after(args.port)
    if free_port == -1:
        print("No free port found in the valid range (0â€“65535).")
        sys.exit(1)

    print(free_port)


if __name__ == "__main__":
    main()

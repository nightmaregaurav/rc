SCRIPT=$(basename "$0")

HELP_MESSAGE="Usage: $SCRIPT
Installs a task in windows system that runs ssh server on 1022 port in the windows session.

Example:
  $SCRIPT"

# Help message
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
  echo "$HELP_MESSAGE"
  exit 0
fi

set -e  # Exit immediately if a command exits with a non-zero status

# Check if the OS is Windows (Git Bash sets 'OS' to 'Windows_NT')
if [ "$OS" != "Windows_NT" ]; then
  echo "Unsupported OS"
  exit 1
fi

# Check if the scheduled task already exists
taskExists=$(powershell.exe -NoProfile -Command "if (Get-ScheduledTask -TaskName 'StartSSHDatLogon' -ErrorAction SilentlyContinue) { Write-Output 'yes' } else { Write-Output 'no' }" | tr -d '\r')

if [ "$taskExists" == "yes" ]; then
  echo "Task 'StartSSHDatLogon' already exists. Skipping."
  echo "To remove the task run: powershell.exe -NoProfile -ExecutionPolicy Bypass -Command \"Unregister-ScheduledTask -TaskName 'StartSSHDatLogon' -Confirm:\\\$false\""
  exit 0
fi

read -r -d '' PS_CODE <<'EOF'
$sshd = "C:\\Program Files\\OpenSSH\\sshd.exe"
$port = 1022
$taskName = "StartSSHDatLogon"
$jsPath = "$env:ProgramData\\StartSSHDHidden.js"

# Create a small JScript file to start sshd hidden
$jsCode = @"
var shell = new ActiveXObject("WScript.Shell");
shell.Run("\"$sshd\" -p $port", 0, false);
"@
Set-Content -Path $jsPath -Value $jsCode -Encoding ASCII

# Create a scheduled task that runs the JS script via wscript.exe (no console)
$action = New-ScheduledTaskAction -Execute "wscript.exe" -Argument "`"$jsPath`""
$trigger = New-ScheduledTaskTrigger -AtLogOn
$principal = New-ScheduledTaskPrincipal -UserId $env:USERNAME -RunLevel Highest
$settings = New-ScheduledTaskSettingsSet -Hidden

Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Description "Start sshd silently at logon"
EOF

# Run PowerShell script to register the task
powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "$PS_CODE"

echo "Task 'StartSSHDatLogon' created successfully."
echo "To remove the task run: powershell.exe -NoProfile -ExecutionPolicy Bypass -Command \"Unregister-ScheduledTask -TaskName 'StartSSHDatLogon' -Confirm:\\\$false\""

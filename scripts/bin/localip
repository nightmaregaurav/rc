#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.14"
# dependencies = [
# ]
# ///

import os
import sys
import socket
import platform
import subprocess

script_name = os.path.basename(sys.argv[0])

HELP_MSG = f"""Usage: {script_name}

Fetches the primary local IP address.

Examples:
  {script_name}
"""

# Show help
if len(sys.argv) > 1 and sys.argv[1] in ("--help", "-h"):
    print(HELP_MSG)
    sys.exit(0)


def get_ip_linux_mac():
    try:
        # Fast socket method
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        if ip and not ip.startswith(("127.", "169.")):
            return ip
    except Exception:
        pass

    # macOS fallback
    if platform.system() == "Darwin":
        for iface in ["en0", "en1"]:
            try:
                ip = subprocess.check_output(
                    ["ipconfig", "getifaddr", iface], stderr=subprocess.DEVNULL
                )
                ip = ip.decode().strip()
                if ip:
                    return ip
            except subprocess.CalledProcessError:
                continue

    # Linux fallback
    try:
        result = subprocess.check_output(
            "ip -4 addr show scope global | grep inet",
            shell=True,
            stderr=subprocess.DEVNULL,
        )
        for line in result.decode().splitlines():
            ip_addr = line.strip().split()[1].split("/")[0]
            if not ip_addr.startswith(("127.", "169.")):
                return ip_addr
    except Exception:
        pass

    return None


def get_ip_windows():
    try:
        cmd = [
            "powershell",
            "-Command",
            "(Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -notlike '169.*' -and $_.IPAddress -notlike '127.*'} | Select-Object -First 1 -ExpandProperty IPAddress)",
        ]
        ip = subprocess.check_output(cmd, stderr=subprocess.DEVNULL).decode().strip()
        if ip:
            return ip
    except Exception:
        pass
    return None


def main():
    os_type = platform.system()
    ip = None

    if os_type in ("Linux", "Darwin"):
        ip = get_ip_linux_mac()
    elif os_type == "Windows":
        ip = get_ip_windows()

    if ip:
        print(ip)
    else:
        sys.exit(1)


if __name__ == "__main__":
    main()

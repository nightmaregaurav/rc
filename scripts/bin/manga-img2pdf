#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.14"
# dependencies = [
#     "argcomplete",
#     "img2pdf",
# ]
# ///

import os
import sys
import argparse
import argcomplete
import img2pdf




def collect_image_paths(folder_path: str) -> list[str]:
    """Return a sorted list of valid image paths in the given folder."""
    valid_exts = (".jpg", ".jpeg", ".png", ".gif")
    images = [
        os.path.join(folder_path, f)
        for f in os.listdir(folder_path)
        if os.path.isfile(os.path.join(folder_path, f))
        and f.lower().endswith(valid_exts)
    ]
    return sorted(images)


def convert_folder_to_pdf(folder_path: str, output_pdf: str) -> None:
    """Convert all images in the folder to a single PDF file."""
    images = collect_image_paths(folder_path)
    if not images:
        print(f"Skipping '{folder_path}': No image files found.")
        return

    try:
        with open(output_pdf, "wb") as pdf_file:
            pdf_file.write(img2pdf.convert(images))
        print(f"Created: {output_pdf}")
    except Exception as e:
        print(f"Error converting '{folder_path}': {e}")
        sys.exit(1)


def main():
    script_name = os.path.basename(sys.argv[0])

    parser = argparse.ArgumentParser(
        prog=script_name,
        description="Convert image folders into PDFs, one PDF per subfolder.",
        epilog=f"Examples:\n  {script_name} /path/to/images",
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False,
    )

    parser.add_argument(
        "-h", "--help",
        action="help",
        help="Show help message and exit.",
    )

    parser.add_argument(
        "path",
        type=str,
        help="Main folder path containing subfolders with images.",
    ).completer = None

    argcomplete.autocomplete(parser, always_complete_options=False)
    args = parser.parse_args()

    main_path = args.path

    if not os.path.isdir(main_path):
        print(f"Error: '{main_path}' is not a valid directory.")
        sys.exit(1)

    subfolders = [
        f for f in os.listdir(main_path)
        if os.path.isdir(os.path.join(main_path, f))
    ]

    if not subfolders:
        print(f"No subfolders found in '{main_path}'.")
        sys.exit(0)

    for subfolder in subfolders:
        folder_path = os.path.join(main_path, subfolder)
        output_pdf_path = os.path.join(main_path, f"{subfolder}.pdf")
        convert_folder_to_pdf(folder_path, output_pdf_path)


if __name__ == "__main__":
    main()

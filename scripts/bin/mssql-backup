#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.10"
# dependencies = [
#     "argcomplete",
# ]
# ///

import subprocess
import sys
import shutil
import argparse
import argcomplete
from datetime import datetime
from pathlib import Path
from argcomplete.completers import DirectoriesCompleter


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def check_sqlpackage_installed() -> None:
    """Ensure sqlpackage is installed and available in PATH (cross-platform)."""
    if shutil.which("sqlpackage") is None:
        print("âŒ Error: 'sqlpackage' command not found in PATH.")
        print("You can install it by running:")
        print("  dotnet tool install -g microsoft.sqlpackage")
        print()
        if sys.platform == "win32":
            print("On Windows, ensure your PATH includes:")
            print("  %USERPROFILE%\\.dotnet\\tools")
        else:
            print("On Linux/macOS, ensure your PATH includes:")
            print("  $HOME/.dotnet/tools")
        sys.exit(1)


def run_command(command: list[str]) -> None:
    """Run a system command and raise an error if it fails."""
    try:
        subprocess.run(command, check=True)
    except subprocess.CalledProcessError as e:
        print(f"âŒ Command failed: {' '.join(command)}")
        print(e)
        sys.exit(1)


def export_database(host: str, user: str, password: str, database: str, output_dir: Path) -> Path:
    """Perform SQL Server database export to .bacpac file."""
    timestamp = datetime.now().strftime("%Y%m%d-%H%M%S")
    filename = f"{database}-{timestamp}.bacpac"
    fullpath = output_dir / filename

    cmd = [
        "sqlpackage",
        f"/Action:Export",
        f"/TargetFile:{fullpath}",
        f"/SourceServerName:{host}",
        f"/SourceDatabaseName:{database}",
        f"/SourceUser:{user}",
        f"/SourcePassword:{password}",
        f"/SourceEncryptConnection:False",
        f"/SourceTrustServerCertificate:True",
    ]

    print(f"ğŸš€ Executing: {' '.join(cmd)}")
    result = subprocess.run(cmd)
    if result.returncode != 0:
        print("âŒ Backup failed!")
        sys.exit(result.returncode)

    print(f"âœ… Backup successful: {fullpath}")
    return fullpath


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main():
    parser = argparse.ArgumentParser(
        description="Export a SQL Server database to a .bacpac file using sqlpackage nuget package.",
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False,
    )

    parser.add_argument(
        "-H", "--host",
        default="localhost",
        help="SQL Server host (default: localhost)"
    )
    parser.add_argument(
        "-U", "--user",
        default="sa",
        help="SQL Server user (default: sa)"
    )
    parser.add_argument(
        "-P", "--password",
        required=True,
        help="SQL Server password"
    )
    parser.add_argument(
        "-D", "--database",
        required=True,
        help="Database name to back up"
    )
    parser.add_argument(
        "-O", "--output",
        default=".",
        help="Output directory (default: current directory)"
    ).completer = DirectoriesCompleter()
    parser.add_argument(
        "-h", "--help",
        action="help",
        help="Show help message and exit"
    )

    argcomplete.autocomplete(parser, always_complete_options=False)
    args = parser.parse_args()

    # Check sqlpackage installation
    check_sqlpackage_installed()

    output_dir = Path(args.output).expanduser().resolve()
    if not output_dir.exists():
        print(f"ğŸ“ Creating output directory: {output_dir}")
        output_dir.mkdir(parents=True, exist_ok=True)

    export_database(
        host=args.host,
        user=args.user,
        password=args.password,
        database=args.database,
        output_dir=output_dir,
    )


if __name__ == "__main__":
    main()

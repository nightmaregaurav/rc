#!/usr/bin/env bash

# Help section
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "Usage: organize-images-and-videos-by-date <folder_path>"
    echo
    echo "Organizes images and videos in the specified folder by their creation date."
    echo
    echo "Examples:"
    echo "  organize-images-and-videos-by-date /path/to/folder"
    exit 0
fi

# Check argument
if [ "$#" -ne 1 ]; then
    echo "Invalid number of arguments."
    echo "Try 'organize-images-and-videos-by-date --help' for more information."
    exit 1
fi

folder="$1"

if [[ ! -d "$folder" ]]; then
    echo "Error: '$folder' is not a valid directory."
    exit 1
fi

echo "Processing files in folder: $folder"

# Supported extensions
shopt -s nullglob
for file in "$folder"/*.{jpg,jpeg,png,gif,mp4,mov,mkv}; do
    echo "---------------------------------------"
    echo "Processing file: $file"

    creation_date=""

    # Get date from image
    if [[ $file =~ \.(jpg|jpeg|png|gif)$ ]]; then
        if ! command -v identify >/dev/null; then
            echo "Error: 'identify' (ImageMagick) not installed."
            exit 1
        fi
        creation_date=$(identify -format "%[EXIF:DateTimeOriginal]" "$file" 2>/dev/null | cut -d' ' -f1)

    # Get date from video
    elif [[ $file =~ \.(mp4|mov|mkv)$ ]]; then
        if ! command -v ffprobe >/dev/null; then
            echo "Error: 'ffprobe' (from ffmpeg) not installed."
            exit 1
        fi
        creation_date=$(ffprobe -v quiet -show_entries format_tags=creation_time \
            -of default=noprint_wrappers=1:nokey=1 "$file" | cut -d'T' -f1)
    fi

    if [[ -z "$creation_date" ]]; then
        echo "No creation date found for '$file'. Skipping."
        continue
    fi

    creation_date=$(echo "$creation_date" | sed 's/:/-/g')
    echo "Normalized creation date: $creation_date"

    formatted_date=$(date -d "$creation_date" +"%d %b %Y" 2>/tmp/date_error.log)
    if [[ $? -ne 0 || -z "$formatted_date" ]]; then
        echo "Error formatting date for '$file'."
        echo "Date command error: $(cat /tmp/date_error.log)"
        continue
    fi

    echo "Formatted date: $formatted_date"

    target_folder="$folder/$formatted_date"
    mkdir -p "$target_folder"
    mv "$file" "$target_folder"
    echo "Moved '$file' to '$target_folder'"
done
shopt -u nullglob

echo "Processing complete."

#!/usr/bin/env python3

import os
import sys
import urllib.request
import socket
import ipaddress

script_name = os.path.basename(sys.argv[0])

HELP_MSG = f"""Usage: {script_name}

Fetches the public IP address.

Examples:
  {script_name}
"""

# Help message
if len(sys.argv) > 1 and sys.argv[1] in ("--help", "-h"):
    print(HELP_MSG)
    sys.exit(0)

urls = [
    "http://whatismyip.akamai.com/",
    "http://ifconfig.io/ip",
    "http://ifconfig.me/ip",
    "http://ipecho.net/plain",
]

addr = "0.0.0.0"

for url in urls:
    try:
        with urllib.request.urlopen(url, timeout=3) as response:
            candidate = response.read().decode().strip()
            # Validate IP
            try:
                ip = ipaddress.ip_address(candidate)
                addr = str(ip)
                break
            except ValueError:
                continue
    except (urllib.error.URLError, socket.timeout):
        continue

print(addr)

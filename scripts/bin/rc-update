#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.14"
# dependencies = [
#     "argcomplete",
#     "GitPython",
# ]
# ///

import argparse
import argcomplete
from pathlib import Path
from git import Repo, GitCommandError


def git_pull(repo_path: Path):
    if not (repo_path / ".git").exists():
        print("Not a Git repository. Skipping update.")
        return

    try:
        repo = Repo(str(repo_path))
    except Exception:
        print("Failed to load Git repository. Skipping update.")
        return

    if repo.bare:
        print("Repository is bare. Skipping update.")
        return

    try:
        origin = repo.remotes.origin
    except AttributeError:
        print("No 'origin' remote found. Skipping update.")
        return

    try:
        print("Pulling latest changes...")
        origin.pull()
        print("Pull complete.")
    except GitCommandError as ex:
        print(f"Git pull failed: {ex}")


def compute_activate_path(script_path: Path) -> Path:
    return (script_path.parent / ".." / ".." / "activate").resolve()


def main():
    parser = argparse.ArgumentParser(
        description="Update rc repository.",
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False,
    )
    parser.add_argument("-h", "--help", action="help", help="Show help message and exit.")
    argcomplete.autocomplete(parser, always_complete_options=False)
    parser.parse_args()

    print("Updating rc...")

    script_path = Path(__file__).resolve()
    repo_path = script_path.parent.parent.parent
    git_pull(repo_path)

    activate_path = compute_activate_path(script_path)
    print()
    print("rc updated.")
    print("To load the latest version, either:")
    print("  1. Exit the shell and reopen it")
    print("  2. Or run manually:")
    print(f"       source \"{activate_path}\"")


if __name__ == "__main__":
    main()

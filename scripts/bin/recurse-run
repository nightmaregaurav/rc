#!/usr/bin/env bash

# Help flag
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
  echo "Usage: recurse-run <command>"
  echo
  echo "Starts a session to recursively run passed commands in all folders in the current directory."
  echo "You can also pass an initial command to run before the recursion starts."
  echo
  echo "Examples:"
  echo "  recurse-run 'echo Hello World'"
  exit 0
fi

initial_command="$*"
master_root_dir=$(pwd)
root_dir=$(pwd)

trap 'echo -e "\nExit signal received!\nGoing back to original directory: $master_root_dir"; cd "$master_root_dir"; exit 1' SIGINT SIGTERM

if [[ -n "$initial_command" ]]; then
  echo "Executing initial command: [$initial_command]"
  eval "$initial_command"
fi

while true; do
  echo "Starting recursion from: $root_dir"
  echo -n "Enter command to run in all subdirectories >>> "
  read -r cmd

  if [[ -z "$cmd" ]]; then
    echo "No command entered. Exiting..."
    break
  fi

  find . -mindepth 1 -maxdepth 1 -type d -not -path '*/\.*' | while IFS= read -r dir; do
    cd "$dir" || continue
    printf '%*s\n' "$(tput cols)" '' | tr ' ' '_'
    echo ">>> [$dir]"
    eval "$cmd"
    cd "$root_dir" || exit
  done

  echo ""
  printf '%*s\n' "$(tput cols)" '' | tr ' ' '*'
  echo "Recursion complete!"
  cd "$root_dir" || exit
done

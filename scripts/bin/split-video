#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.14"
# dependencies = [
#   "argcomplete",
#   "ffmpeg-python",
# ]
# ///

import os
import sys
import ffmpeg
import argparse
import argcomplete


def split_video(input_file: str, output_prefix: str, segment_duration: str) -> None:
    """Splits a video into segments of given duration using ffmpeg-python."""
    if not os.path.isfile(input_file):
        print(f"Error: '{input_file}' does not exist.")
        sys.exit(1)

    try:
        (
            ffmpeg
            .input(input_file)
            .output(
                f"{output_prefix}%03d.mp4",
                c="copy",
                map=0,
                f="segment",
                segment_time=segment_duration,
                reset_timestamps=1,
                avoid_negative_ts="make_zero",
            )
            .run(quiet=False, overwrite_output=True)
        )
    except ffmpeg.Error as e:
        sys.stderr.write(e.stderr.decode() if hasattr(e, "stderr") else str(e))
        sys.exit(1)


def complete_segment_duration(prefix, parsed_args, **_):
    durations = ["00:05:00", "00:10:00", "00:15:00"]
    return [d for d in durations if d.startswith(prefix)]


def main():
    parser = argparse.ArgumentParser(
        description="Split a video into smaller segments using FFmpeg.",
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False,
    )

    parser.add_argument("input", help="Input video file path.")
    parser.add_argument("output_prefix", help="Output file prefix.")
    parser.add_argument(
        "segment_duration",
        nargs="?",
        default="00:10:00",
        help="Duration of each segment (default: 00:10:00).",
    ).completer = complete_segment_duration

    parser.add_argument(
        "-h", "--help",
        action="help",
        help="Show help message and exit.",
    )

    argcomplete.autocomplete(parser, always_complete_options=False)
    args = parser.parse_args()

    split_video(args.input, args.output_prefix, args.segment_duration)


if __name__ == "__main__":
    main()

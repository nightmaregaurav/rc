#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.10"
# dependencies = [
#     "argcomplete",
# ]
# ///

import subprocess
import sys
import base64
import argparse
import argcomplete
from pathlib import Path


TASK_NAME = "StartSSHDatLogon"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def powershell(cmd: str) -> str:
    """Run a short PowerShell command and return its stdout."""
    result = subprocess.run(
        ["powershell.exe", "-NoProfile", "-ExecutionPolicy", "Bypass", "-Command", cmd],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        raise RuntimeError(result.stderr.strip())
    return result.stdout.strip()


def powershell_script(script: str):
    """Run a full multi-line PowerShell script safely via -EncodedCommand."""
    encoded = base64.b64encode(script.encode("utf-16le")).decode("ascii")
    subprocess.run(
        ["powershell.exe", "-NoProfile", "-ExecutionPolicy", "Bypass", "-EncodedCommand", encoded],
        check=True,
    )


def task_exists() -> bool:
    """Return True if the scheduled task already exists."""
    ps = (
        f"$t = Get-ScheduledTask -TaskName '{TASK_NAME}' -ErrorAction SilentlyContinue; "
        "if ($null -ne $t) { Write-Host 'yes' -NoNewline } else { Write-Host 'no' -NoNewline }"
    )
    result = subprocess.run(
        ["powershell.exe", "-NoProfile", "-ExecutionPolicy", "Bypass", "-Command", ps],
        capture_output=True,
    )
    output = (result.stdout or b"").decode("utf-8", errors="ignore").strip().lower()
    return "yes" in output


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def install_task():
    sshd_path = Path(r"C:\Program Files\OpenSSH\sshd.exe")
    if not sshd_path.exists():
        print(f"âŒ sshd.exe not found at: {sshd_path}")
        print ("It is possible that you are using windows built-in OpenSSH which is installed as optional feature.")
        print("This script requires the OpenSSH Server installed via winget (or official installer) to work properly.")
        print("Please uninstall the built-in OpenSSH Server optional feature and install OpenSSH via winget:")
        print("  winget install OpenSSH.Server")
        sys.exit(1)

    if task_exists():
        print(f"âœ… Task '{TASK_NAME}' already exists.")
        return

    ps_code = r'''
$sshd = "C:\Program Files\OpenSSH\sshd.exe"
$port = 1022
$retryCount = 3
$retryIntervalMinutes = 1
$taskName = "StartSSHDatLogon"
$jsPath = "$env:ProgramData\StartSSHDHidden.js"

# Create JScript file to start sshd hidden
$jsCode = @'
try {
    var shell = new ActiveXObject("WScript.Shell");
    shell.Run("\"C:\\Program Files\\OpenSSH\\sshd.exe\" -p 1022", 0, false);
} catch (e) {}
'@
Set-Content -Path $jsPath -Value $jsCode -Encoding ASCII

# Create scheduled task action
$action = New-ScheduledTaskAction -Execute "wscript.exe" -Argument ("`"$jsPath`"")

# Add multiple triggers: logon, startup, and wake
$trigger = @(
    New-ScheduledTaskTrigger -AtLogOn
    New-ScheduledTaskTrigger -AtStartup
)

# Principal and settings with restart-on-failure
$principal = New-ScheduledTaskPrincipal -UserId $env:USERNAME -RunLevel Highest
$settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RestartCount $retryCount -RestartInterval (New-TimeSpan -Minutes $retryIntervalMinutes) -MultipleInstances IgnoreNew -Hidden

# Register the task
Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Description "Start sshd silently at logon/startup/resume"
'''
    print("ğŸ”§ Creating scheduled taskâ€¦")
    powershell_script(ps_code)
    print(f"âœ… Task '{TASK_NAME}' created successfully.")


def uninstall_task():
    if not task_exists():
        print(f"â„¹ï¸  Task '{TASK_NAME}' does not exist.")
        return
    print("ğŸ§¹ Removing scheduled taskâ€¦")
    cmd = f"Unregister-ScheduledTask -TaskName '{TASK_NAME}' -Confirm:$false"
    powershell(cmd)
    js_path = Path(r"C:\ProgramData\StartSSHDHidden.js")
    if js_path.exists():
        try:
            js_path.unlink()
            print(f"ğŸ—‘ï¸  Deleted {js_path}")
        except Exception as e:
            print(f"âš ï¸  Could not delete {js_path}: {e}")
    print(f"âœ… Task '{TASK_NAME}' removed.")


def status_task():
    if task_exists():
        print(f"âœ… Task '{TASK_NAME}' is registered.")
    else:
        print(f"âŒ Task '{TASK_NAME}' not found.")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main():
    parser = argparse.ArgumentParser(
        description=(
            "Manage a Windows Scheduled Task that runs sshd hidden "
            "in the user session on port 1022."
        ),
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False,
    )

    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument("-i", "--install", action="store_true", help="Install the scheduled task.")
    group.add_argument("-u", "--uninstall", action="store_true", help="Remove the scheduled task.")
    group.add_argument("-s", "--status", action="store_true", help="Show task status.")

    parser.add_argument("-h", "--help", action="help", help="Show help message and exit.")
    argcomplete.autocomplete(parser, always_complete_options=False)
    args = parser.parse_args()

    if sys.platform != "win32":
        print("âŒ Unsupported OS â€” must be run on Windows.")
        sys.exit(1)

    if args.install:
        install_task()
    elif args.uninstall:
        uninstall_task()
    elif args.status:
        status_task()


if __name__ == "__main__":
    main()

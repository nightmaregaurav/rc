#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.14"
# dependencies = [
#   "argcomplete",
# ]
# ///

import argparse
import platform
import subprocess
import sys
import json
import argcomplete


# ----------------------------- Utils ----------------------------- #

def run_command(cmd: list[str]) -> str | None:
    """Safely run a subprocess command and return stripped stdout, or None if failed."""
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        return result.stdout.strip()
    except Exception:
        return None


def detect_android() -> bool:
    """Detect if running inside Android (e.g., Termux)."""
    try:
        uname = run_command(["uname", "-o"])
        return bool(uname and "Android" in uname)
    except Exception:
        return False


# ----------------------------- macOS ----------------------------- #

def mac_get():
    """Return volume string like 'xx%' or 'xx% (muted)'."""
    vol = run_command(["osascript", "-e", "output volume of (get volume settings)"])
    muted = run_command(["osascript", "-e", "output muted of (get volume settings)"])
    if not vol:
        return None
    vol = vol.strip()
    if muted and muted.strip().lower() == "true":
        return f"{vol}% (muted)"
    return f"{vol}%"


def mac_set(level: int):
    return run_command(["osascript", "-e", f"set volume output volume {level}"]) is not None

def mac_mute():
    return run_command(["osascript", "-e", "set volume with output muted"]) is not None

def mac_unmute():
    return run_command(["osascript", "-e", "set volume without output muted"]) is not None


# ----------------------------- Linux ----------------------------- #

def linux_get():
    """Return volume string like 'xx%' or 'xx% (muted)'."""
    # Try pactl first
    output = run_command(["pactl", "get-sink-volume", "@DEFAULT_SINK@"])
    mute = run_command(["pactl", "get-sink-mute", "@DEFAULT_SINK@"])
    if output:
        for token in output.split():
            if token.endswith("%"):
                vol = token.strip("%")
                if mute and "yes" in mute.lower():
                    return f"{vol}% (muted)"
                return f"{vol}%"

    # Fallback: amixer
    output = run_command(["amixer", "get", "Master"])
    if output:
        import re
        vol_match = re.search(r"\[(\d+)%\]", output)
        mute_match = re.search(r"\[(on|off)\]", output)
        if vol_match:
            vol = vol_match.group(1)
            if mute_match and mute_match.group(1).lower() == "off":
                return f"{vol}% (muted)"
            return f"{vol}%"
    return None

def linux_set(level: int):
    return bool(run_command(["pactl", "set-sink-volume", "@DEFAULT_SINK@", f"{level}%"]) or
                run_command(["amixer", "set", "Master", f"{level}%"]))

def linux_mute():
    return bool(run_command(["pactl", "set-sink-mute", "@DEFAULT_SINK@", "1"]) or
                run_command(["amixer", "set", "Master", "mute"]))

def linux_unmute():
    return bool(run_command(["pactl", "set-sink-mute", "@DEFAULT_SINK@", "0"]) or
                run_command(["amixer", "set", "Master", "unmute"]))


# ----------------------------- Windows ----------------------------- #

def ensure_audio_device_cmdlets() -> bool:
    """Ensure that the AudioDeviceCmdlets PowerShell module is installed and imported."""
    check_cmd = [
        "powershell", "-NoProfile", "-Command",
        "if (Get-Module -ListAvailable -Name AudioDeviceCmdlets) { Write-Output 'OK' }"
    ]
    if run_command(check_cmd) == "OK":
        return True

    install_cmd = [
        "powershell", "-NoProfile", "-Command",
        "try { Install-Module -Name AudioDeviceCmdlets -Force -Scope CurrentUser -ErrorAction Stop; Write-Output 'OK' } "
        "catch { Write-Output 'FAIL' }"
    ]
    result = run_command(install_cmd)
    return result == "OK"


def win_get() -> str | None:
    """Return volume string like 'xx%' or 'xx% (muted)'."""
    vol_cmd = "Get-AudioDevice -PlaybackVolume"
    mute_cmd = "Get-AudioDevice -PlaybackCommunicationMute"
    vol = run_command(["powershell", "-NoProfile", "-Command", vol_cmd])
    mute = run_command(["powershell", "-NoProfile", "-Command", mute_cmd])
    if not vol:
        return None
    vol = vol.strip()
    if mute and mute.strip().lower() == "true":
        return f"{vol} (muted)"
    return vol


def win_set(level: int) -> bool:
    ps = f"Set-AudioDevice -PlaybackVolume {level}"
    return run_command(["powershell", "-NoProfile", "-Command", ps]) is not None

def win_mute() -> bool:
    ps = "Set-AudioDevice -PlaybackCommunicationMute $true"
    return run_command(["powershell", "-NoProfile", "-Command", ps]) is not None

def win_unmute() -> bool:
    ps = "Set-AudioDevice -PlaybackCommunicationMute $false"
    return run_command(["powershell", "-NoProfile", "-Command", ps]) is not None


# ----------------------------- Android (Termux) ----------------------------- #

def android_get():
    """Return volume string like 'xx%' or 'xx% (muted)'."""
    out = run_command(["termux-volume"])
    if not out:
        return None
    try:
        data = json.loads(out)
        for stream in data:
            if stream["stream"] == "music":
                vol = int(stream["volume"] * 100 / stream["max_volume"])
                if vol == 0:
                    return f"{vol}% (muted)"
                return f"{vol}%"
    except Exception:
        pass
    return None

def android_set(level: int):
    scaled = max(0, min(15, int(level / 100 * 15)))
    return run_command(["termux-volume", "music", str(scaled)]) is not None

def android_mute():
    return run_command(["termux-volume", "music", "0"]) is not None

def android_unmute():
    # Restore to 50% as a heuristic
    return run_command(["termux-volume", "music", "7"]) is not None


# ----------------------------- Unified Interface ----------------------------- #

def get_volume():
    sysname = platform.system().lower()
    if detect_android():
        return android_get()
    if "darwin" in sysname:
        return mac_get()
    if "linux" in sysname:
        return linux_get()
    if "windows" in sysname:
        ensure_audio_device_cmdlets()
        return win_get()
    return None


def set_volume(level: int):
    sysname = platform.system().lower()
    if detect_android():
        return android_set(level)
    if "darwin" in sysname:
        return mac_set(level)
    if "linux" in sysname:
        return linux_set(level)
    if "windows" in sysname:
        ensure_audio_device_cmdlets()
        return win_set(level)
    return False


def mute_volume():
    sysname = platform.system().lower()
    if detect_android():
        return android_mute()
    if "darwin" in sysname:
        return mac_mute()
    if "linux" in sysname:
        return linux_mute()
    if "windows" in sysname:
        ensure_audio_device_cmdlets()
        return win_mute()
    return False


def unmute_volume():
    sysname = platform.system().lower()
    if detect_android():
        return android_unmute()
    if "darwin" in sysname:
        return mac_unmute()
    if "linux" in sysname:
        return linux_unmute()
    if "windows" in sysname:
        ensure_audio_device_cmdlets()
        return win_unmute()
    return False


# ----------------------------- CLI ----------------------------- #

def main():
    parser = argparse.ArgumentParser(
        description="Get, set, mute, or unmute the system's master volume (cross-platform, includes Termux support).",
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False,
    )

    parser.add_argument("-h", "--help", action="help", help="Show help message and exit.")
    parser.add_argument("-s", "--set", help="Set system volume (e.g., 50%%)")
    parser.add_argument("-m", "--mute", action="store_true", help="Mute system output")
    parser.add_argument("-u", "--unmute", action="store_true", help="Unmute system output")
    parser.add_argument("-g", "--get", action="store_true", help="Print current volume percentage")

    argcomplete.autocomplete(parser, always_complete_options=False)
    args = parser.parse_args()

    if args.get:
        vol = get_volume()
        if vol is not None:
            print(vol)
        else:
            sys.exit("Error: Unable to read system volume.")
        return

    if args.mute:
        if not mute_volume():
            sys.exit("Error: Failed to mute system volume.")
        return

    if args.unmute:
        if not unmute_volume():
            sys.exit("Error: Failed to unmute system volume.")
        return

    if args.set:
        try:
            level = int(args.set.strip().rstrip("%"))
            if not (0 <= level <= 100):
                raise ValueError
        except ValueError:
            sys.exit("Error: Volume must be a number between 0â€“100.")
        if not set_volume(level):
            sys.exit("Error: Failed to set system volume.")
        return

    parser.print_help()


if __name__ == "__main__":
    main()

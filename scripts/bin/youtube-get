#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.14"
# dependencies = [
#   "yt-dlp",
#   "argcomplete",
# ]
# ///

import sys
import argparse
import argcomplete
from yt_dlp import YoutubeDL


def build_options(mode: str) -> dict:
    base_opts = {
        "nocheckcertificate": True,
        "concurrent_fragment_downloads": 4,
        "outtmpl": "%(title)s.%(ext)s",
        "quiet": False,
    }

    match mode:
        case "bestaudio":
            base_opts["format"] = "bestaudio/bestaudio"
        case "mp3":
            base_opts.update({
                "format": "bestaudio/bestaudio",
                "postprocessors": [
                    {"key": "FFmpegExtractAudio", "preferredcodec": "mp3"}
                ],
            })
        case "bestvideo":
            base_opts["format"] = "bestvideo+bestaudio/bestvideo+bestaudio"
        case "mp4":
            base_opts["format"] = (
                "bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo+bestaudio"
            )
        case _:
            raise ValueError(f"Unknown mode '{mode}'. Valid: bestaudio, mp3, bestvideo, mp4")

    return base_opts


def download(mode: str, urls: list[str]) -> None:
    opts = build_options(mode)
    with YoutubeDL(opts) as ydl:
        for url in urls:
            print(f"Downloading {url} with mode {mode}...")
            try:
                ydl.download([url])
            except Exception as e:
                print(f"Error downloading {url}: {e}")


def main() -> None:
    parser = argparse.ArgumentParser(
        prog="youtube-get",
        description="Download YouTube videos or audio using the yt-dlp Python API.",
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False,
    )

    parser.add_argument(
        "mode",
        choices=["bestaudio", "mp3", "bestvideo", "mp4"],
        default="mp4",
        help="Download mode (default: mp4).",
    ).completer = None  # choices already provide sensible completion

    parser.add_argument(
        "urls",
        nargs="+",
        help="One or more YouTube URLs to download.",
    )

    parser.add_argument(
        "-h", "--help",
        action="help",
        help="Show help message and exit.",
    )

    argcomplete.autocomplete(parser, always_complete_options=False)
    args = parser.parse_args()

    try:
        download(args.mode, args.urls)
    except Exception as e:
        print(f"Fatal error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()

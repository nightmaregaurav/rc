#!/usr/bin/env bash

_mssql_restore() {
    local cur prev
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    # All flags
    local flags=("-H" "--host" "-U" "--user" "-P" "--password" "-D" "--database" "-F" "--file" "-h" "--help")

    # Flags that require a value
    local flags_with_values=("-H" "--host" "-U" "--user" "-P" "--password" "-D" "--database" "-F" "--file")

    # If previous word is a flag expecting a value, do nothing
    for flag in "${flags_with_values[@]}"; do
        if [[ "$prev" == "$flag" ]]; then
            return
        fi
    done

    # Track used flags
    local used_flags=()
    for word in "${COMP_WORDS[@]}"; do
        for flag in "${flags[@]}"; do
            if [[ "$word" == "$flag" ]]; then
                used_flags+=("$flag")
            fi
        done
    done

    # Suggest unused flags only
    local suggestions=()
    for flag in "${flags[@]}"; do
        if [[ ! " ${used_flags[*]} " =~ " $flag " ]]; then
            suggestions+=("$flag")
        fi
    done

    COMPREPLY=( $(compgen -W "${suggestions[*]}" -- "$cur") )
}

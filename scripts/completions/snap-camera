#!/usr/bin/env bash

_snap_from_source() {
    local cur prev
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    # All flags
    local flags=("-s" "--source" "-d" "--destination" "-h" "--help")

    # Flags that require a value
    local flags_with_values=("-s" "--source" "-d" "--destination")

    # If previous word is a flag expecting a value, do nothing (user typing the value)
    for flag in "${flags_with_values[@]}"; do
        if [[ "$prev" == "$flag" ]]; then
            return
        fi
    done

    # Track which flags were already used
    local used_flags=()
    for word in "${COMP_WORDS[@]}"; do
        for flag in "${flags[@]}"; do
            if [[ "$word" == "$flag" ]]; then
                used_flags+=("$flag")
            fi
        done
    done

    # Suggest only unused flags
    local suggestions=()
    for flag in "${flags[@]}"; do
        if [[ ! " ${used_flags[*]} " =~ " $flag " ]]; then
            suggestions+=("$flag")
        fi
    done

    COMPREPLY=( $(compgen -W "${suggestions[*]}" -- "$cur") )
}

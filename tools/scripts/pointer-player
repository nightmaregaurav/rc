#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.14"
# dependencies = [
#     "argcomplete",
#     "pynput",
# ]
# ///

import argparse
import argcomplete
import re
import time
from pynput.mouse import Controller, Button

mouse = Controller()

TAG_PATTERN = re.compile(
    r'<(?P<close>/)?'
    r'(?P<tag>[A-Za-z]+)'
    r'(?P<attrs>(?:\s+[a-zA-Z_]+="[^"]*")*)'
    r'\s*(?P<self>/)?>'
)

def parse_attrs(attr_string):
    attrs = {}
    if not attr_string:
        return attrs
    for key, val in re.findall(r'([a-zA-Z_]+)="([^"]*)"?', attr_string):
        attrs[key] = val
    return attrs

def load_events_from_string(s):
    events = []
    for m in TAG_PATTERN.finditer(s):
        tag = m.group("tag")
        attrs = parse_attrs(m.group("attrs"))
        is_close = m.group("close") is not None
        is_self = m.group("self") is not None
        events.append((tag, attrs, is_close, is_self))
    return events

def log(msg):
    print(msg, flush=True)

def replay(events):
    previous_timestamp = 0
    active_click = {}

    for tag, attrs, is_close, is_self in events:
        t = int(attrs.get("t", "0"))
        delay_ms = t - previous_timestamp
        delay = delay_ms / 1000

        if delay > 0:
            log(f"[Delay] {delay_ms} ms")
            time.sleep(delay)

        previous_timestamp = t

        if tag == "Pos":
            x = float(attrs["x"])
            y = float(attrs["y"])
            log(f"[Move] â†’ ({x}, {y})")
            mouse.position = (x, y)

        elif tag == "Click":
            button_name = attrs["button"]
            button = getattr(Button, button_name.lower())
            x = float(attrs["x"])
            y = float(attrs["y"])

            if is_self:
                log(f"[Click] Autoclick {button_name} at ({x}, {y})")
                mouse.position = (x, y)
                mouse.press(button)
                mouse.release(button)
                continue

            if not is_close:
                log(f"[Click Down] {button_name} at ({x}, {y})")
                mouse.position = (x, y)
                active_click[button_name] = (x, y)
                mouse.press(button)

            else:
                log(f"[Click Up] {button_name} at ({x}, {y})")
                mouse.position = (x, y)
                mouse.release(button)
                active_click.pop(button_name, None)

        elif tag == "ScrollVertical":
            x = float(attrs["x"])
            y = float(attrs["y"])
            direction = attrs["direction"]
            dy = 1 if direction == "UP" else -1
            log(f"[Scroll Vertical] {direction} at ({x}, {y})")
            mouse.position = (x, y)
            mouse.scroll(0, dy)

        elif tag == "ScrollHorizontal":
            x = float(attrs["x"])
            y = float(attrs["y"])
            direction = attrs["direction"]
            dx = 1 if direction == "RIGHT" else -1
            log(f"[Scroll Horizontal] {direction} at ({x}, {y})")
            mouse.position = (x, y)
            mouse.scroll(dx, 0)

def main():
    parser = argparse.ArgumentParser(
        description="Replays a recorded mouse macro from XML-like event stream with transparent logging.",
        formatter_class=argparse.RawTextHelpFormatter,
        add_help=False
    )

    parser.add_argument("macro", help="The macro string or file path.")
    parser.add_argument("-f", "--file", action="store_true", help="Interpret macro argument as file path.")
    parser.add_argument("-h", "--help", action="help", help="Show help.")

    argcomplete.autocomplete(parser)
    args = parser.parse_args()

    if args.file:
        with open(args.macro, "r", encoding="utf8") as fp:
            content = fp.read()
    else:
        content = args.macro

    events = load_events_from_string(content)

    print("Replaying macro with full transparency. Do not touch mouse.")
    time.sleep(1)

    replay(events)

    print("\nDone.")

if __name__ == "__main__":
    main()
